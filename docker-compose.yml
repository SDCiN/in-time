# =============================================================================
# iN!Time - Docker Compose (Production)
# =============================================================================
# Uso: docker compose up -d --build
#
# Este arquivo é para PRODUÇÃO
# - Todos os microserviços são expostos apenas via Nginx (porta 8500)
# - PostgreSQL dedicado na porta 5433 (não confundir com worklocation-db:5432)
# - Rede intime-network isolada dos demais projetos da VM
# =============================================================================

version: '3.8'

# ─── Bases reutilizáveis ─────────────────────────────────────────────────────
x-service-base: &service-base
  restart: always
  networks:
    - intime-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# Base para microserviços que dependem de PostgreSQL + Redis
x-backend-base: &backend-base
  <<: *service-base
  env_file:
    - ./server/.env
  environment:
    # Sobrescreve o .env: aponta para os containers internos com o usuário dedicado
    - DB_HOST=postgres
    - DB_PORT=5432
    - DB_NAME=intime_dev
    - DB_USER=intime_admin
    - DB_PASSWORD=${INTIME_DB_PASSWORD:-intime_Change_Me_2025!}
    - REDIS_HOST=redis
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy

# =============================================================================
# Services
# =============================================================================
services:

  # ---------------------------------------------------------------------------
  # Banco de dados - PostgreSQL 16
  # ---------------------------------------------------------------------------
  postgres:
    <<: *service-base
    image: postgres:16-alpine
    container_name: intime-postgres
    environment:
      POSTGRES_DB: intime_dev
      # Usuário dedicado – NÃO use 'postgres'. Troque a senha antes de ir para produção.
      POSTGRES_USER: intime_admin
      POSTGRES_PASSWORD: ${INTIME_DB_PASSWORD:-intime_Change_Me_2025!}
    ports:
      - "5433:5432"           # Acesso externo restrito a este host (PgAdmin/psql)
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U intime_admin -d intime_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Banco de dados - MongoDB 7.0 (Audit Logs)
  # ---------------------------------------------------------------------------
  mongodb:
    <<: *service-base
    image: mongo:7.0
    container_name: intime-mongodb
    environment:
      MONGO_INITDB_DATABASE: intime_audit
    ports:
      - "27017:27017"         # Exposto para acesso direto (Compass, mongosh)
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ---------------------------------------------------------------------------
  # Banco de dados - Redis 7.4 (Cache / Pub-Sub / Sessões)
  # ---------------------------------------------------------------------------
  redis:
    <<: *service-base
    image: redis:7.4-alpine
    container_name: intime-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"           # Exposto para acesso direto (redis-cli, RedisInsight)
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # API Gateway (porta interna: 3000)
  # ---------------------------------------------------------------------------
  api-gateway:
    <<: *service-base
    build:
      context: ./server
      dockerfile: api-gateway/Dockerfile
    image: intime-api-gateway:latest
    container_name: intime-api-gateway
    env_file:
      - ./server/.env
    environment:
      - REDIS_HOST=redis
      # URLs internas dos microserviços (sobrescrevem o .env que usa localhost)
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USER_SERVICE_URL=http://user-service:3002
      - PROJECT_SERVICE_URL=http://project-service:3003
      - TIMESHEET_SERVICE_URL=http://timesheet-service:3004
      - ALLOCATION_SERVICE_URL=http://allocation-service:3005
      - CONTRACT_SERVICE_URL=http://contract-service:3006
      - FINANCIAL_SERVICE_URL=http://financial-service:3007
      - NOTIFICATION_SERVICE_URL=http://notification-service:3008
      - EXPORT_SERVICE_URL=http://export-service:3009
      - AUDIT_SERVICE_URL=http://audit-service:3010
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Microserviços
  # Todos usam build context ./server para acessar shared/
  # DB_HOST e REDIS_HOST sobrescrevem o .env (que usa IPs externos)
  # ---------------------------------------------------------------------------
  auth-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/auth-service/Dockerfile
    image: intime-auth-service:latest
    container_name: intime-auth-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  user-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/user-service/Dockerfile
    image: intime-user-service:latest
    container_name: intime-user-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  project-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/project-service/Dockerfile
    image: intime-project-service:latest
    container_name: intime-project-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  timesheet-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/timesheet-service/Dockerfile
    image: intime-timesheet-service:latest
    container_name: intime-timesheet-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  allocation-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/allocation-service/Dockerfile
    image: intime-allocation-service:latest
    container_name: intime-allocation-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  contract-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/contract-service/Dockerfile
    image: intime-contract-service:latest
    container_name: intime-contract-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  financial-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/financial-service/Dockerfile
    image: intime-financial-service:latest
    container_name: intime-financial-service
    environment:
      # Herda x-backend-base + sobrescreve pool para cálculos EVM
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=intime_dev
      - DB_USER=intime_admin
      - DB_PASSWORD=${INTIME_DB_PASSWORD:-intime_Change_Me_2025!}
      - REDIS_HOST=redis
      - DB_POOL_MAX=10
      - DB_POOL_MIN=2
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  notification-service:
    <<: *service-base
    build:
      context: ./server
      dockerfile: services/notification-service/Dockerfile
    image: intime-notification-service:latest
    container_name: intime-notification-service
    env_file:
      - ./server/.env
    environment:
      - REDIS_HOST=redis
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  export-service:
    <<: *backend-base
    build:
      context: ./server
      dockerfile: services/export-service/Dockerfile
    image: intime-export-service:latest
    container_name: intime-export-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  audit-service:
    <<: *service-base
    build:
      context: ./server
      dockerfile: services/audit-service/Dockerfile
    image: intime-audit-service:latest
    container_name: intime-audit-service
    env_file:
      - ./server/.env
    environment:
      - MONGODB_URI=mongodb://mongodb:27017/intime_audit
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Frontend (React SPA servido por Nginx interno)
  # ---------------------------------------------------------------------------
  client:
    <<: *service-base
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /intime/api/v1        # Relativo – o Nginx faz o proxy (subpath /intime)
        VITE_SOCKET_URL: /intime/socket.io  # Socket.io via /intime/socket.io/ no Nginx
    image: intime-client:latest
    container_name: intime-client

  # ---------------------------------------------------------------------------
  # Nginx – Ponto de entrada único (porta 8500)
  # Porta 80 ocupada por hub-pmo-frontend na VM
  #
  #  /            → client:80          (React SPA)
  #  /api/        → api-gateway:3000   (REST API)
  #  /socket.io/  → notification:3008  (WebSocket)
  # ---------------------------------------------------------------------------
  nginx:
    <<: *service-base
    image: nginx:1.24-alpine
    container_name: intime-nginx
    ports:
      - "8500:80"             # http://interno.sandech.local:8500/intime/
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - client
      - api-gateway
      - notification-service

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
  mongodb_data:
  redis_data:

# =============================================================================
# Networks
# =============================================================================
networks:
  intime-network:
    driver: bridge
